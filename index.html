<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.163">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-08-31">

<title>Graphs in Solr - Graphing around with Solr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Graphs in Solr</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./starting_points.html">Nodes and Edges</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./graph_traversal01.html">Graph Traversals</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./test_graph_setup.html">Setup</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Graphing around with Solr</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Notes on querying graphs in Solr</p>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 31, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>This document outlines how Solr may be used as a <a href="https://neo4j.com/blog/rdf-triple-store-vs-labeled-property-graph-difference/">labelled property graph</a>, and provides some common query patterns for exploring related content.</p>
<p>Solr graph operations basically involve a breadth-first scan across documents connected by some property from a starting set of documents and optionally applying filters during the traversal or on the resulting set of documents.</p>
<p>The following solr document structure is used for these examples. Two nodes are described, <code>a</code> and <code>aa</code>. The node <code>aa</code> contains a single edge of type <code>subsample-of</code> with a target node of <code>a</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">[</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="fu">{</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>        <span class="dt">"id"</span><span class="fu">:</span><span class="st">"a"</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>        <span class="dt">"name_t"</span><span class="fu">:</span><span class="st">"parent a"</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>        <span class="dt">"is_s"</span><span class="fu">:</span><span class="st">"sample"</span><span class="fu">,</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>        <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"a"</span><span class="fu">,</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    <span class="fu">{</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="dt">"id"</span><span class="fu">:</span><span class="st">"aa"</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>        <span class="dt">"name_t"</span><span class="fu">:</span><span class="st">"sub aa"</span><span class="fu">,</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="dt">"is_s"</span><span class="fu">:</span><span class="st">"sample"</span><span class="fu">,</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>        <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"aa"</span><span class="fu">,</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>        <span class="dt">"edges"</span><span class="fu">:</span><span class="ot">[</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>            <span class="fu">{</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>                <span class="dt">"id"</span><span class="fu">:</span><span class="st">"111"</span><span class="fu">,</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>                <span class="dt">"relation_type_s"</span><span class="fu">:</span><span class="st">"subsample-of"</span><span class="fu">,</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>                <span class="dt">"target_s"</span><span class="fu">:</span><span class="st">"a"</span><span class="fu">,</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>                <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"aa"</span><span class="fu">,</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>                <span class="dt">"_nest_parent_"</span><span class="fu">:</span><span class="st">"aa"</span><span class="fu">,</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>                <span class="dt">"_nest_path_"</span><span class="fu">:</span><span class="st">"/related#0"</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>            <span class="fu">}</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>        <span class="ot">]</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>    <span class="fu">}</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="ot">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The fields <code>_root_</code>, <code>_nest_parent_</code>, and <code>_nest_path_</code> are computed by Solr, and should not be included in the documents when indexing.</p>
</div>
</div></div><p>Each document structure has two parts - the main document and a optional list of nested child documents that capture relationships with other documents. In this pattern, the outer document is a node of the property graph, and the child <code>edges</code> documents are the edges. Both nodes and edges may have many properties. Solr will index each of these as individually addressable documents and the index will have columns matching the union of columns used in the node documents and in the edge documents. The above example might appear in the index like (excluding the Solr calculated fields):</p>
<table class="table">
<thead>
<tr class="header">
<th>id</th>
<th>name_t</th>
<th>is_s</th>
<th>relation_type_s</th>
<th>target_s</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>a</code></td>
<td><code>parent a</code></td>
<td><code>sample</code></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><code>aa</code></td>
<td><code>sub aa</code></td>
<td><code>sample</code></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td><code>111</code></td>
<td></td>
<td></td>
<td><code>subsample-of</code></td>
<td><code>a</code></td>
</tr>
</tbody>
</table>
<p>The resulting solr index has documents <code>a</code>, <code>aa</code> and <code>111</code> in the index with their respective properties. Note that Solr also includes additional properties that record the nested structure. In particular, the properties <code>_nest_parent_</code>, <code>_nest_path_</code>, and <code>_root_</code> (the latter defaulting to not being presentable in results).</p>
<p>The following graph is used in the examples of different operations.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> example_graph</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">import</span> graphutzing</span>
<span id="cb2-3"><a href="#cb2-3"></a>graphutzing.generateViz(example_graph.docs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<p><img src="index_files/figure-html/cell-2-output-1.svg" class="img-fluid"></p>
</div>
</div>
<p>In the example graph, relations are uni-directional asserting a statement such as “ab is a subsample-of a” and “aaba is an analysis-of aab”, and so forth. The different shapes represent different types of entities as indicated by the <code>is_s</code> property.</p>
<p>The complete list of documents in <code>example_graph</code> is shown in <a href="#tbl-records">Table&nbsp;1</a>:</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="im">import</span> IPython.display</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="im">import</span> tabulate</span>
<span id="cb3-3"><a href="#cb3-3"></a>solr <span class="op">=</span> graphutzing.SolrConnection()</span>
<span id="cb3-4"><a href="#cb3-4"></a>res <span class="op">=</span> solr.query(data<span class="op">=</span>{<span class="st">"q"</span>:<span class="st">"*:*"</span>, <span class="st">"rows"</span>:<span class="dv">100</span>, <span class="st">"sort"</span>:<span class="st">"is_s DESC, id ASC"</span>,})</span>
<span id="cb3-5"><a href="#cb3-5"></a>header <span class="op">=</span> [<span class="st">"id"</span>,<span class="st">"name_t"</span>,<span class="st">"is_s"</span>,<span class="st">"relation_type_s"</span>,<span class="st">"target_s"</span>,<span class="st">"`_nest_parent_`"</span>]</span>
<span id="cb3-6"><a href="#cb3-6"></a>rows <span class="op">=</span> []</span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="cf">for</span> doc <span class="kw">in</span> res.get(<span class="st">"response"</span>,{}).get(<span class="st">"docs"</span>,[]):</span>
<span id="cb3-8"><a href="#cb3-8"></a>    row <span class="op">=</span> [doc.get(<span class="st">"id"</span>,<span class="st">""</span>),doc.get(<span class="st">"name_t"</span>,<span class="st">""</span>),doc.get(<span class="st">"is_s"</span>,<span class="st">""</span>),doc.get(<span class="st">"relation_type_s"</span>,<span class="st">""</span>),doc.get(<span class="st">"target_s"</span>,<span class="st">""</span>), doc.get(<span class="st">"_nest_parent_"</span>,<span class="st">""</span>)]</span>
<span id="cb3-9"><a href="#cb3-9"></a>    rows.append(row)</span>
<span id="cb3-10"><a href="#cb3-10"></a>IPython.display.Markdown(tabulate.tabulate(</span>
<span id="cb3-11"><a href="#cb3-11"></a>    rows,</span>
<span id="cb3-12"><a href="#cb3-12"></a>    headers<span class="op">=</span>header,</span>
<span id="cb3-13"><a href="#cb3-13"></a>    tablefmt<span class="op">=</span><span class="st">"pipe"</span>,</span>
<span id="cb3-14"><a href="#cb3-14"></a>    colalign<span class="op">=</span>(<span class="st">"right"</span>,)</span>
<span id="cb3-15"><a href="#cb3-15"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="2">
<div id="tbl-records" class="anchored">
<table class="table table-sm table-striped">
<caption>Table&nbsp;1: List of records indexed in <code>example_graph</code>.</caption>
<colgroup>
<col style="width: 7%">
<col style="width: 17%">
<col style="width: 15%">
<col style="width: 22%">
<col style="width: 14%">
<col style="width: 22%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">id</th>
<th style="text-align: left;">name_t</th>
<th style="text-align: left;">is_s</th>
<th style="text-align: left;">relation_type_s</th>
<th style="text-align: left;">target_s</th>
<th style="text-align: left;"><code>_nest_parent_</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">a</td>
<td style="text-align: left;">parent a</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">aa</td>
<td style="text-align: left;">sub aa</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">aa2</td>
<td style="text-align: left;">sub aa2</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">aab</td>
<td style="text-align: left;">sub aab</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">ab</td>
<td style="text-align: left;">sub ab</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">b</td>
<td style="text-align: left;">parent b</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">ba</td>
<td style="text-align: left;">sub ba</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">bb</td>
<td style="text-align: left;">sub bb</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">c</td>
<td style="text-align: left;">independent c</td>
<td style="text-align: left;">sample</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">ccc</td>
<td style="text-align: left;">publication</td>
<td style="text-align: left;">publication</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">ddd</td>
<td style="text-align: left;">publication</td>
<td style="text-align: left;">publication</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">aaa</td>
<td style="text-align: left;">analysis aaa</td>
<td style="text-align: left;">analysis</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">aaba</td>
<td style="text-align: left;">sub aaba</td>
<td style="text-align: left;">analysis</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: right;">baa</td>
<td style="text-align: left;">analysis baa</td>
<td style="text-align: left;">analysis</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: right;">111</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">subsample-of</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">aa</td>
</tr>
<tr class="even">
<td style="text-align: right;">1111</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">subsample-of</td>
<td style="text-align: left;">aa</td>
<td style="text-align: left;">aa2</td>
</tr>
<tr class="odd">
<td style="text-align: right;">112</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">subsample-of</td>
<td style="text-align: left;">a</td>
<td style="text-align: left;">ab</td>
</tr>
<tr class="even">
<td style="text-align: right;">113</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">analysis-of</td>
<td style="text-align: left;">aa</td>
<td style="text-align: left;">aaa</td>
</tr>
<tr class="odd">
<td style="text-align: right;">114</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">subsample-of</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">ba</td>
</tr>
<tr class="even">
<td style="text-align: right;">114</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">analysis-of</td>
<td style="text-align: left;">aa2</td>
<td style="text-align: left;">aaa</td>
</tr>
<tr class="odd">
<td style="text-align: right;">115</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">analysis-of</td>
<td style="text-align: left;">ba</td>
<td style="text-align: left;">baa</td>
</tr>
<tr class="even">
<td style="text-align: right;">1151</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">analysis-of</td>
<td style="text-align: left;">aab</td>
<td style="text-align: left;">aaba</td>
</tr>
<tr class="odd">
<td style="text-align: right;">120</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">subsample-of</td>
<td style="text-align: left;">ab</td>
<td style="text-align: left;">aab</td>
</tr>
<tr class="even">
<td style="text-align: right;">121</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">subsample-of</td>
<td style="text-align: left;">b</td>
<td style="text-align: left;">bb</td>
</tr>
<tr class="odd">
<td style="text-align: right;">ccc1</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">references</td>
<td style="text-align: left;">aaa</td>
<td style="text-align: left;">ccc</td>
</tr>
<tr class="even">
<td style="text-align: right;">ccc2</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">references</td>
<td style="text-align: left;">baa</td>
<td style="text-align: left;">ccc</td>
</tr>
<tr class="odd">
<td style="text-align: right;">ddd1</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">references</td>
<td style="text-align: left;">ccc</td>
<td style="text-align: left;">ddd</td>
</tr>
<tr class="even">
<td style="text-align: right;">ddd2</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;">references</td>
<td style="text-align: left;">aaba</td>
<td style="text-align: left;">ddd</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


<!-- -->


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb4" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">---</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="an">title:</span><span class="co"> Graphing around with Solr</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="an">subtitle:</span><span class="co"> Notes on querying graphs in Solr</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="an">date:</span><span class="co"> 2022-08-31</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">---</span></span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a>This document outlines how Solr may be used as a <span class="co">[</span><span class="ot">labelled property graph</span><span class="co">](https://neo4j.com/blog/rdf-triple-store-vs-labeled-property-graph-difference/)</span>, and provides some common query patterns for exploring related content.</span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a></span>
<span id="cb4-12"><a href="#cb4-12"></a>Solr graph operations basically involve a breadth-first scan across documents connected by some property from a starting set of documents and optionally applying filters during the traversal or on the resulting set of documents.</span>
<span id="cb4-13"><a href="#cb4-13"></a></span>
<span id="cb4-14"><a href="#cb4-14"></a>The following solr document structure is used for these examples. Two nodes are described, <span class="in">`a`</span> and <span class="in">`aa`</span>. The node <span class="in">`aa`</span> contains a single edge of type <span class="in">`subsample-of`</span> with a target node of <span class="in">`a`</span>:</span>
<span id="cb4-15"><a href="#cb4-15"></a></span>
<span id="cb4-16"><a href="#cb4-16"></a><span class="in">```{.json}</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>[</span>
<span id="cb4-18"><a href="#cb4-18"></a>    {</span>
<span id="cb4-19"><a href="#cb4-19"></a>        <span class="st">"id"</span><span class="op">:</span><span class="st">"a"</span><span class="op">,</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>        <span class="st">"name_t"</span><span class="op">:</span><span class="st">"parent a"</span><span class="op">,</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="st">"is_s"</span><span class="op">:</span><span class="st">"sample"</span><span class="op">,</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>        <span class="st">"_root_"</span><span class="op">:</span><span class="st">"a"</span><span class="op">,</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>    }<span class="op">,</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>    {</span>
<span id="cb4-25"><a href="#cb4-25"></a>        <span class="st">"id"</span><span class="op">:</span><span class="st">"aa"</span><span class="op">,</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>        <span class="st">"name_t"</span><span class="op">:</span><span class="st">"sub aa"</span><span class="op">,</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>        <span class="st">"is_s"</span><span class="op">:</span><span class="st">"sample"</span><span class="op">,</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>        <span class="st">"_root_"</span><span class="op">:</span><span class="st">"aa"</span><span class="op">,</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>        <span class="st">"edges"</span><span class="op">:</span>[</span>
<span id="cb4-30"><a href="#cb4-30"></a>            {</span>
<span id="cb4-31"><a href="#cb4-31"></a>                <span class="st">"id"</span><span class="op">:</span><span class="st">"111"</span><span class="op">,</span></span>
<span id="cb4-32"><a href="#cb4-32"></a>                <span class="st">"relation_type_s"</span><span class="op">:</span><span class="st">"subsample-of"</span><span class="op">,</span></span>
<span id="cb4-33"><a href="#cb4-33"></a>                <span class="st">"target_s"</span><span class="op">:</span><span class="st">"a"</span><span class="op">,</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>                <span class="st">"_root_"</span><span class="op">:</span><span class="st">"aa"</span><span class="op">,</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>                <span class="st">"_nest_parent_"</span><span class="op">:</span><span class="st">"aa"</span><span class="op">,</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>                <span class="st">"_nest_path_"</span><span class="op">:</span><span class="st">"/related#0"</span></span>
<span id="cb4-37"><a href="#cb4-37"></a>            }</span>
<span id="cb4-38"><a href="#cb4-38"></a>        ]</span>
<span id="cb4-39"><a href="#cb4-39"></a>    }</span>
<span id="cb4-40"><a href="#cb4-40"></a>]</span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="in">```</span></span>
<span id="cb4-42"><a href="#cb4-42"></a>::: {.column-margin .callout-note}</span>
<span id="cb4-43"><a href="#cb4-43"></a>The fields <span class="in">`_root_`</span>, <span class="in">`_nest_parent_`</span>, and <span class="in">`_nest_path_`</span> are computed by Solr, and should not be included in the documents when indexing.</span>
<span id="cb4-44"><a href="#cb4-44"></a>:::</span>
<span id="cb4-45"><a href="#cb4-45"></a></span>
<span id="cb4-46"><a href="#cb4-46"></a>Each document structure has two parts - the main document and a optional list of nested child documents that capture relationships with other documents. In this pattern, the outer document is a node of the property graph, and the child <span class="in">`edges`</span> documents are the edges. Both nodes and edges may have many properties. Solr will index each of these as individually addressable documents and the index will have columns matching the union of columns used in the node documents and in the edge documents. The above example might appear in the index like (excluding the Solr calculated fields):</span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a>| id | name_t | is_s| relation_type_s | target_s |</span>
<span id="cb4-49"><a href="#cb4-49"></a>| -- | -- | -- | -- | -- |</span>
<span id="cb4-50"><a href="#cb4-50"></a>| <span class="in">`a`</span> | <span class="in">`parent a`</span> | <span class="in">`sample`</span> | | |</span>
<span id="cb4-51"><a href="#cb4-51"></a>| <span class="in">`aa`</span> | <span class="in">`sub aa`</span> | <span class="in">`sample`</span> | | |</span>
<span id="cb4-52"><a href="#cb4-52"></a>| <span class="in">`111`</span> | | | <span class="in">`subsample-of`</span> | <span class="in">`a`</span> |</span>
<span id="cb4-53"><a href="#cb4-53"></a></span>
<span id="cb4-54"><a href="#cb4-54"></a></span>
<span id="cb4-55"><a href="#cb4-55"></a>The resulting solr index has documents <span class="in">`a`</span>, <span class="in">`aa`</span> and <span class="in">`111`</span> in the index with their respective properties. Note that Solr also includes additional properties that record the nested structure. In particular, the properties <span class="in">`_nest_parent_`</span>, <span class="in">`_nest_path_`</span>, and <span class="in">`_root_`</span> (the latter defaulting to not being presentable in results).</span>
<span id="cb4-56"><a href="#cb4-56"></a></span>
<span id="cb4-57"><a href="#cb4-57"></a>The following graph is used in the examples of different operations.</span>
<span id="cb4-58"><a href="#cb4-58"></a></span>
<span id="cb4-61"><a href="#cb4-61"></a><span class="in">```{python}</span></span>
<span id="cb4-62"><a href="#cb4-62"></a><span class="im">import</span> example_graph</span>
<span id="cb4-63"><a href="#cb4-63"></a><span class="im">import</span> graphutzing</span>
<span id="cb4-64"><a href="#cb4-64"></a>graphutzing.generateViz(example_graph.docs)</span>
<span id="cb4-65"><a href="#cb4-65"></a><span class="in">```</span></span>
<span id="cb4-66"><a href="#cb4-66"></a></span>
<span id="cb4-67"><a href="#cb4-67"></a>In the example graph, relations are uni-directional asserting a statement such as "ab is a subsample-of a" and "aaba is an analysis-of aab", and so forth. The different shapes represent different types of entities as indicated by the <span class="in">`is_s`</span> property.</span>
<span id="cb4-68"><a href="#cb4-68"></a></span>
<span id="cb4-69"><a href="#cb4-69"></a>The complete list of documents in <span class="in">`example_graph`</span> is shown in @tbl-records:</span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="in">```{python}</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="co">#| label: tbl-records</span></span>
<span id="cb4-74"><a href="#cb4-74"></a><span class="co">#| tbl-cap: List of records indexed in `example_graph`.</span></span>
<span id="cb4-75"><a href="#cb4-75"></a><span class="im">import</span> IPython.display</span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="im">import</span> tabulate</span>
<span id="cb4-77"><a href="#cb4-77"></a>solr <span class="op">=</span> graphutzing.SolrConnection()</span>
<span id="cb4-78"><a href="#cb4-78"></a>res <span class="op">=</span> solr.query(data<span class="op">=</span>{<span class="st">"q"</span>:<span class="st">"*:*"</span>, <span class="st">"rows"</span>:<span class="dv">100</span>, <span class="st">"sort"</span>:<span class="st">"is_s DESC, id ASC"</span>,})</span>
<span id="cb4-79"><a href="#cb4-79"></a>header <span class="op">=</span> [<span class="st">"id"</span>,<span class="st">"name_t"</span>,<span class="st">"is_s"</span>,<span class="st">"relation_type_s"</span>,<span class="st">"target_s"</span>,<span class="st">"`_nest_parent_`"</span>]</span>
<span id="cb4-80"><a href="#cb4-80"></a>rows <span class="op">=</span> []</span>
<span id="cb4-81"><a href="#cb4-81"></a><span class="cf">for</span> doc <span class="kw">in</span> res.get(<span class="st">"response"</span>,{}).get(<span class="st">"docs"</span>,[]):</span>
<span id="cb4-82"><a href="#cb4-82"></a>    row <span class="op">=</span> [doc.get(<span class="st">"id"</span>,<span class="st">""</span>),doc.get(<span class="st">"name_t"</span>,<span class="st">""</span>),doc.get(<span class="st">"is_s"</span>,<span class="st">""</span>),doc.get(<span class="st">"relation_type_s"</span>,<span class="st">""</span>),doc.get(<span class="st">"target_s"</span>,<span class="st">""</span>), doc.get(<span class="st">"_nest_parent_"</span>,<span class="st">""</span>)]</span>
<span id="cb4-83"><a href="#cb4-83"></a>    rows.append(row)</span>
<span id="cb4-84"><a href="#cb4-84"></a>IPython.display.Markdown(tabulate.tabulate(</span>
<span id="cb4-85"><a href="#cb4-85"></a>    rows,</span>
<span id="cb4-86"><a href="#cb4-86"></a>    headers<span class="op">=</span>header,</span>
<span id="cb4-87"><a href="#cb4-87"></a>    tablefmt<span class="op">=</span><span class="st">"pipe"</span>,</span>
<span id="cb4-88"><a href="#cb4-88"></a>    colalign<span class="op">=</span>(<span class="st">"right"</span>,)</span>
<span id="cb4-89"><a href="#cb4-89"></a>))</span>
<span id="cb4-90"><a href="#cb4-90"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">© Copyright 2022, iSamples Project. This material is based upon work supported by the National Science Foundation under Grant Numbers <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004839">2004839</a>, <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004562">2004562</a>, <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004642">2004642</a>, and <a href="https://nsf.gov/awardsearch/showAward?AWD_ID=2004815">2004815</a>. Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the <a href="https://nsf.gov/">National Science Foundation</a>.</div>   
  </div>
</footer>



</body></html>