<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.163">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-08-30">

<title>Graphs in Solr - Graphing around with Solr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Graphs in Solr</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./starting_points.html">Nodes and Edges</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./graph_traversal01.html" aria-current="page">Graph Traversals</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#ancestors" id="toc-ancestors" class="nav-link active" data-scroll-target="#ancestors">Ancestors</a>
  <ul class="collapse">
  <li><a href="#ancestors-of-a-specific-node" id="toc-ancestors-of-a-specific-node" class="nav-link" data-scroll-target="#ancestors-of-a-specific-node">Ancestors of a specific node</a></li>
  <li><a href="#ancestors-matching-some-property" id="toc-ancestors-matching-some-property" class="nav-link" data-scroll-target="#ancestors-matching-some-property">Ancestors matching some property</a></li>
  </ul></li>
  <li><a href="#descendants" id="toc-descendants" class="nav-link" data-scroll-target="#descendants">Descendants</a>
  <ul class="collapse">
  <li><a href="#descendants-of-a-node" id="toc-descendants-of-a-node" class="nav-link" data-scroll-target="#descendants-of-a-node">Descendants of a node</a></li>
  <li><a href="#descendants-matching-a-particular-type" id="toc-descendants-matching-a-particular-type" class="nav-link" data-scroll-target="#descendants-matching-a-particular-type">Descendants matching a particular type</a></li>
  </ul></li>
  <li><a href="#graph-math" id="toc-graph-math" class="nav-link" data-scroll-target="#graph-math">Graph Math</a>
  <ul class="collapse">
  <li><a href="#union-of-two-graphs" id="toc-union-of-two-graphs" class="nav-link" data-scroll-target="#union-of-two-graphs">Union of two graphs</a></li>
  <li><a href="#difference-of-two-graphs" id="toc-difference-of-two-graphs" class="nav-link" data-scroll-target="#difference-of-two-graphs">Difference of two graphs</a></li>
  <li><a href="#number-of-nodes-in-a-graph" id="toc-number-of-nodes-in-a-graph" class="nav-link" data-scroll-target="#number-of-nodes-in-a-graph">Number of nodes in a graph</a></li>
  </ul></li>
  <li><a href="#other-solr-graph-methods" id="toc-other-solr-graph-methods" class="nav-link" data-scroll-target="#other-solr-graph-methods">Other Solr graph methods</a>
  <ul class="collapse">
  <li><a href="#shortestpath" id="toc-shortestpath" class="nav-link" data-scroll-target="#shortestpath"><code>shortestPath</code></a></li>
  <li><a href="#nodes" id="toc-nodes" class="nav-link" data-scroll-target="#nodes"><code>nodes</code></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Graphing around with Solr</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Traversing graphs</p>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 30, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<section id="ancestors" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="ancestors">Ancestors</h2>
<p>In the graph model used here the arrows are pointing from the descendant to the ancestor. It is done this way for practical purposes - it is easier to add edges to a derived record than to update an origin record each time a derivative is made. Hence, a <code>subsample-of</code> relation here indicates that the record containing the relation is a subsample of the target of that relation, and the origin is an ancestor of the record. This basic pattern is shown in <a href="#fig-ancestry">Figure&nbsp;1</a>.</p>
<div class="cell" data-fig-height="1.5">
<div class="cell-output-display">
<div id="fig-ancestry" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p>
<svg width="672" height="144" viewbox="0.00 0.00 731.33 66.83" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 62.83)"> <polygon fill="white" stroke="transparent" points="-4,4 -4,-62.83 727.33,-62.83 727.33,4 -4,4"></polygon> <!-- node1 --> <g id="node1" class="node">
<title>
node1
</title>
<ellipse fill="none" stroke="black" cx="644.95" cy="-29.42" rx="78.25" ry="29.33"></ellipse> <text text-anchor="middle" x="644.95" y="-33.62" font-family="Times,serif" font-size="14.00">Decendant</text> <text text-anchor="middle" x="644.95" y="-16.82" font-family="Times,serif" font-size="14.00">A derived record</text> </g> <!-- node2 --> <g id="node2" class="node">
<title>
node2
</title>
<ellipse fill="none" stroke="black" cx="366.06" cy="-29.42" rx="89.18" ry="29.33"></ellipse> <text text-anchor="middle" x="366.06" y="-33.62" font-family="Times,serif" font-size="14.00">Ancestor</text> <text text-anchor="middle" x="366.06" y="-16.82" font-family="Times,serif" font-size="14.00">Intermediate record</text> </g> <!-- node1&#45;&gt;node2 --> <g id="edge1" class="edge">
<title>
node1-&gt;node2
</title>
<path fill="none" stroke="black" d="M566.45,-29.42C535.13,-29.42 498.62,-29.42 465.46,-29.42"></path> <polygon fill="black" stroke="black" points="465.28,-25.92 455.28,-29.42 465.28,-32.92 465.28,-25.92"></polygon> <text text-anchor="middle" x="510.86" y="-33.62" font-family="Times,serif" font-size="14.00">subsample-of</text> </g> <!-- node3 --> <g id="node3" class="node">
<title>
node3
</title>
<ellipse fill="none" stroke="black" cx="82.77" cy="-29.42" rx="82.54" ry="29.33"></ellipse> <text text-anchor="middle" x="82.77" y="-33.62" font-family="Times,serif" font-size="14.00">Ancestor2</text> <text text-anchor="middle" x="82.77" y="-16.82" font-family="Times,serif" font-size="14.00">The source record</text> </g> <!-- node2&#45;&gt;node3 --> <g id="edge2" class="edge">
<title>
node2-&gt;node3
</title>
<path fill="none" stroke="black" d="M276.83,-29.42C244.84,-29.42 208.64,-29.42 176.3,-29.42"></path> <polygon fill="black" stroke="black" points="175.94,-25.92 165.94,-29.42 175.94,-32.92 175.94,-25.92"></polygon> <text text-anchor="middle" x="221.26" y="-33.62" font-family="Times,serif" font-size="14.00">subsample-of</text> </g> </g>
</svg>
</p>
<p></p><figcaption class="figure-caption">Figure&nbsp;1: Ancestor2 is the original source record, Ancestor is a <code>sample-of</code> Ancestor2, and Descendant is a <code>sample-of</code> Ancestor.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Expressed as JSON records:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource json number-lines code-with-copy"><code class="sourceCode json"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">[</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>    <span class="fu">{</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>        <span class="dt">"id"</span><span class="fu">:</span><span class="st">"Ancestor2"</span><span class="fu">,</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>        <span class="dt">"name_t"</span><span class="fu">:</span><span class="st">"The source record"</span><span class="fu">,</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>        <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"Ancestor"</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="fu">{</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>        <span class="dt">"id"</span><span class="fu">:</span><span class="st">"Ancestor"</span><span class="fu">,</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="dt">"name_t"</span><span class="fu">:</span><span class="st">"A derived record"</span><span class="fu">,</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>        <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"Ancestor"</span><span class="fu">,</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="dt">"edges"</span><span class="fu">:</span><span class="ot">[</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>            <span class="fu">{</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>                <span class="dt">"id"</span><span class="fu">:</span><span class="st">"relation_01"</span><span class="fu">,</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>                <span class="dt">"relation_type_s"</span><span class="fu">:</span><span class="st">"subsample-of"</span><span class="fu">,</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>                <span class="dt">"target_s"</span><span class="fu">:</span><span class="st">"Ancestor2"</span><span class="fu">,</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>                <span class="dt">"_nest_parent_"</span><span class="fu">:</span><span class="st">"Ancestor"</span><span class="fu">,</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>                <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"Ancestor"</span><span class="fu">,</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>                <span class="dt">"_nest_path_"</span><span class="fu">:</span><span class="st">"/edges#0"</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>            <span class="fu">}</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>        <span class="ot">]</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>    <span class="fu">{</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>        <span class="dt">"id"</span><span class="fu">:</span><span class="st">"Descendant"</span><span class="fu">,</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>        <span class="dt">"name_t"</span><span class="fu">:</span><span class="st">"Another derived record"</span><span class="fu">,</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>        <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"Descendant"</span><span class="fu">,</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>        <span class="dt">"edges"</span><span class="fu">:</span><span class="ot">[</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>            <span class="fu">{</span></span>
<span id="cb1-28"><a href="#cb1-28"></a>                <span class="dt">"id"</span><span class="fu">:</span><span class="st">"relation_02"</span><span class="fu">,</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>                <span class="dt">"relation_type_s"</span><span class="fu">:</span><span class="st">"subsample-of"</span><span class="fu">,</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>                <span class="dt">"target_s"</span><span class="fu">:</span><span class="st">"Ancestor"</span><span class="fu">,</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>                <span class="dt">"_nest_parent_"</span><span class="fu">:</span><span class="st">"Descendant"</span><span class="fu">,</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>                <span class="dt">"_root_"</span><span class="fu">:</span><span class="st">"Descendant"</span><span class="fu">,</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>                <span class="dt">"_nest_path_"</span><span class="fu">:</span><span class="st">"/edges#0"</span></span>
<span id="cb1-34"><a href="#cb1-34"></a>            <span class="fu">}</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>        <span class="ot">]</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>    <span class="fu">}</span></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="ot">]</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

<div class="no-row-height column-margin column-container"><div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The fields <code>_root_</code>, <code>_nest_parent_</code>, and <code>_nest_path_</code> are computed by Solr, and should not be included in the documents when indexing. They are included here to indicate the values set by Solr.</p>
</div>
</div></div><p>The basic form of a solr query for this operation is a <a href="https://solr.apache.org/guide/solr/latest/query-guide/other-parsers.html#graph-query-parser">graph expression</a> traversing from a descendant record to targets of the relations.</p>
<p>The graph query:</p>
<pre><code>{!graph from=FROM_FIELD to=TO_FIELD}ROOT_DOCUMENTS</code></pre>
<p>roughly corresponds to the pseudo code:</p>
<pre><code>start_docs = ROOT_DOCUMENTS
while start_docs is not empty:
    for each document in start_docs:
        for each value of TO_FIELD:
            set start_docs to documents with FROM_FIELD matching value</code></pre>
<p>Where:</p>
<dl>
<dt>FROM_FIELD</dt>
<dd>
Name of the field examined for incoming edges.
</dd>
<dt>TO_FIELD</dt>
<dd>
Name of the field listing outgoing edges.
</dd>
<dt>ROOT_DOCUMENTS</dt>
<dd>
The list of documents providing starting points for graph traversal.
</dd>
</dl>
<p>In the two node example above, <code>FROM_FIELD</code> corresponds to the parent of the <code>related</code> edge documents and <code>TO_FIELD</code> corresponds with the <code>target_s</code> value of the edge document.</p>
<p>Since relations are held in the nested documents, it is necessary to seed the starting points of the graph traversal with the nested child relation documents, however we are typically quarying on properties of the parent of the nested child. Hence the root nodes for starting the traversal are found by selecting the child documents of parent documents that match some filter. This is done using the Solr <a href="https://solr.apache.org/guide/solr/latest/query-guide/searching-nested-documents.html#child-query-parser"><code>!child</code></a> query parser:</p>
<pre><code>{!child of=PARENT_MASK}SOME_PARENTS</code></pre>
<p>where:</p>
<dl>
<dt>SOME_PARENTS</dt>
<dd>
Query returing some parent documents, e.g.&nbsp;<code>*:*</code> or <code>id:Descendant</code>.
</dd>
<dt>PARENT_MASK</dt>
<dd>
Filter applied to SOME_PARENTS. This will typically match all parent documents, e.g.&nbsp;<code>*:* -_nest_path_:*</code> (all documents in SOME_PARENTS that don’t have a <code>_nest_path_</code> field).
</dd>
</dl>
<p>Combining the <code>!graph</code> and <code>!child</code> query parsers provides a pattern facilitating traversal across ancestor documents. For example:</p>
<pre><code>{!graph 
    from=_nest_parent_ 
    to=target_s
}(  
    {!child
        of="*:* -_nest_path_:*"
    }id:Descendant
)</code></pre>
<p>Says given the child document of the document with <code>id</code> of “<code>Descendant</code>”, get documents with <code>_nest_parent_</code> matching the value of <code>_target_s</code>. At this point, we have all the <code>related</code> nested documents that point to ancestors of “<code>Descendant</code>”, which in this case is simply the single document with identifier “<code>relation_01</code>”.</p>
<p>Note that the ancestors are actually the documents that are referenced from the value of the <code>target_s</code> field. There are a couple options to retrieve those documents. One is the <a href="https://solr.apache.org/guide/solr/latest/query-guide/join-query-parser.html"><code>!join</code></a> query parser:</p>
<pre><code>{!join
    from=target_s
    to=id
}(
    {!graph 
        from=_nest_parent_ 
        to=target_s
    }(  
        {!child
            of="*:* -_nest_path_:*"
        }id:Descendant
    )
)</code></pre>
<p>An alternative, when using streaming expressesions is to use the <a href="https://solr.apache.org/guide/solr/latest/query-guide/stream-decorator-reference.html#fetch"><code>fetch</code></a> stream decorator:</p>
<pre><code>fetch(COLLECTION,
    search(COLLECTION,
        q="{!graph 
                from=_nest_parent_ 
                to=target_s
            }(  
            {!child
                of='*:* -_nest_path_:*'
            }id:Descendant
        )",
    ),
    fl="id, name_t",
    on="target_s=id"
)</code></pre>
<section id="ancestors-of-a-specific-node" class="level3">
<h3 class="anchored" data-anchor-id="ancestors-of-a-specific-node">Ancestors of a specific node</h3>
<p>The two ancestor approaches are illustrated here using the <code>example_graph</code>.</p>
<p>In both cases, we are looking for all records that are the ancestors of the node <code>id:ddd</code>. This could easily be expanded to include many starting root nodes by adjusting the initial filter query to match multiple nodes..</p>
<p>The first uses the <code>!join</code> query expression. See <a href="#fig-n1">Figure&nbsp;2</a>.</p>
<div class="cell" data-execution_count="1">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> example_graph</span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="im">import</span> graphutzing</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>solr <span class="op">=</span> graphutzing.SolrConnection()</span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>ex0 <span class="op">=</span> <span class="st">'''search(reltest,</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="st">    q="{!join </span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="st">            from=target_s </span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="st">            to=id</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="st">        }{!graph </span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="st">            from=_nest_parent_ </span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="st">            to=target_s</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="st">        }({!child </span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="st">            of='*:* -_nest_path_:*'</span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="st">        }id:ddd)",</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="st">    fl="*",</span></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="st">    rows=100</span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="st">)'''</span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="bu">print</span>(ex0)</span>
<span id="cb8-20"><a href="#cb8-20"></a>res <span class="op">=</span> solr.sendExpr(ex0)</span>
<span id="cb8-21"><a href="#cb8-21"></a>solr.render(example_graph.docs, res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>search(reltest,
    q="{!join 
            from=target_s 
            to=id
        }{!graph 
            from=_nest_parent_ 
            to=target_s
        }({!child 
            of='*:* -_nest_path_:*'
        }id:ddd)",
    fl="*",
    rows=100
)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-n1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="graph_traversal01_files/figure-html/fig-n1-output-2.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;2: A line plot on a polar axis</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>The second uses the <code>fetch</code> stream decorator, see <a href="#fig-n2">Figure&nbsp;3</a>:</p>
<div class="cell" data-execution_count="2">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>ex1 <span class="op">=</span> <span class="st">'''search(reltest,</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">        q="{!graph </span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="st">            to=target_s </span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="st">            from=_nest_parent_</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="st">        }({!child </span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="st">            of='*:* -_nest_path_:*'</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="st">        }id:ddd)",</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="st">        fl="*",</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="st">        rows=100</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="st">    )'''</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>ex2 <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="ss">fetch(reltest,</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="ss">    </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="ss">    fl="id,name_t",</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="ss">    on="target_s=id"</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="ss">)'''</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="bu">print</span>(ex2)</span>
<span id="cb10-18"><a href="#cb10-18"></a>res <span class="op">=</span> solr.sendExpr(ex2)</span>
<span id="cb10-19"><a href="#cb10-19"></a>solr.render(example_graph.docs, res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
fetch(reltest,
    search(reltest,
        q="{!graph 
            to=target_s 
            from=_nest_parent_
        }({!child 
            of='*:* -_nest_path_:*'
        }id:ddd)",
        fl="*",
        rows=100
    ),
    fl="id,name_t",
    on="target_s=id"
)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="fig-n2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="graph_traversal01_files/figure-html/fig-n2-output-2.svg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;3: A line plot on a polar axis</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ancestors-matching-some-property" class="level3">
<h3 class="anchored" data-anchor-id="ancestors-matching-some-property">Ancestors matching some property</h3>
<p>This pattern can be used to find ancestors that match a filter.</p>
<p>In this case, documents that are the ancestor of <code>ccc</code> are found by an ancestor graph traversal, then only the documents from that set that are samples (<code>is_s:sample</code>) are returned.</p>
<div class="cell" data-execution_count="3">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>ex1 <span class="op">=</span> <span class="st">'''    search(reltest, </span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="st">            q="{!graph </span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="st">                to=target_s </span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="st">                from=_nest_parent_</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="st">            }(_nest_parent_:ccc)",</span></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="st">            fl="*,target_s,_nest_parent_,[child]",</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="st">            rows=100</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="st">        )'''</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co"># Using the fetch operation to retrieve fields from documents found in the graph walk</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>ex2 <span class="op">=</span> <span class="ss">f'''fetch(reltest,</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="ss">    </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="ss">        fl="id,name_t,is_s,[child]",</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="ss">        on="target_s=id"</span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="ss">    )'''</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>ex3 <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="ss">having(</span></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="ss">    </span><span class="sc">{</span>ex2<span class="sc">}</span><span class="ss">, </span></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="ss">    eq(is_s,"sample")</span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="ss">)'''</span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="bu">print</span>(ex3)</span>
<span id="cb12-21"><a href="#cb12-21"></a>res <span class="op">=</span> solr.sendExpr(ex3)</span>
<span id="cb12-22"><a href="#cb12-22"></a>solr.render(example_graph.docs, res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
having(
    fetch(reltest,
        search(reltest, 
            q="{!graph 
                to=target_s 
                from=_nest_parent_
            }(_nest_parent_:ccc)",
            fl="*,target_s,_nest_parent_,[child]",
            rows=100
        ),
        fl="id,name_t,is_s,[child]",
        on="target_s=id"
    ), 
    eq(is_s,"sample")
)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="graph_traversal01_files/figure-html/cell-4-output-2.svg" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="descendants" class="level2">
<h2 class="anchored" data-anchor-id="descendants">Descendants</h2>
<p>Finding Descendants is similar to finding ancestors, except we are walking the graph in the opposite direction, so the <code>to</code> and <code>from</code> properties of the <code>!graph</code> expression are reversed. Since the Descendants contain the nested relations, retrieving the parent document is a bit simpler since it is just the documents with <code>id</code> matching <code>_nest_parent_</code>.</p>
<section id="descendants-of-a-node" class="level3">
<h3 class="anchored" data-anchor-id="descendants-of-a-node">Descendants of a node</h3>
<p>In this example derivatives (i.e.&nbsp;Descendants) of <code>id:b</code> are found.</p>
<div class="cell" data-execution_count="4">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>ex1 <span class="op">=</span> <span class="st">'''    search(</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">        reltest,</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">        q="{!graph </span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">            to=_nest_parent_ </span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">            from=target_s</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">        }target_s:b",</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="st">        fl="*",</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="st">        rows=100</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="st">    )'''</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>ex2 <span class="op">=</span> <span class="ss">f'''fetch(</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="ss">    reltest,</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="ss">    </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="ss">    fl="id,name_t,[child]",</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="ss">    on="_nest_parent_=id"</span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="ss">)</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="ss">'''</span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="bu">print</span>(ex2)</span>
<span id="cb14-18"><a href="#cb14-18"></a>res <span class="op">=</span> solr.sendExpr(ex2)</span>
<span id="cb14-19"><a href="#cb14-19"></a>solr.render(example_graph.docs, res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>fetch(
    reltest,
        search(
        reltest,
        q="{!graph 
            to=_nest_parent_ 
            from=target_s
        }target_s:b",
        fl="*",
        rows=100
    ),
    fl="id,name_t,[child]",
    on="_nest_parent_=id"
)
</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="graph_traversal01_files/figure-html/cell-5-output-2.svg" class="img-fluid"></p>
</div>
</div>
<p>Alternatively, we can use the <code>!parent</code> query parser to similar effect:</p>
<div class="cell" data-execution_count="5">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>ex1 <span class="op">=</span> <span class="st">'''search(reltest,</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="st">    q="{!parent which='*:* -_nest_path_:*'}({!graph </span></span>
<span id="cb16-3"><a href="#cb16-3"></a><span class="st">        to=_nest_parent_ </span></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="st">        from=target_s</span></span>
<span id="cb16-5"><a href="#cb16-5"></a><span class="st">    }target_s:b)",</span></span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="st">    fl="*",</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="st">    rows=100</span></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="st">)'''</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="bu">print</span>(ex1)</span>
<span id="cb16-10"><a href="#cb16-10"></a>res <span class="op">=</span> solr.sendExpr(ex1)</span>
<span id="cb16-11"><a href="#cb16-11"></a>solr.render(example_graph.docs, res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>search(reltest,
    q="{!parent which='*:* -_nest_path_:*'}({!graph 
        to=_nest_parent_ 
        from=target_s
    }target_s:b)",
    fl="*",
    rows=100
)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="graph_traversal01_files/figure-html/cell-6-output-2.svg" class="img-fluid"></p>
</div>
</div>
</section>
<section id="descendants-matching-a-particular-type" class="level3">
<h3 class="anchored" data-anchor-id="descendants-matching-a-particular-type">Descendants matching a particular type</h3>
<p>In this case we are looking for analyses that were performed on material derived from sample <code>a</code>.</p>
<p>We follow the Descendants graph, but limit the traversal to only include <code>sample-of</code> or <code>analysis-of</code> relations to limit the reduce the scope of traversal. This exclusion is optional, but included here to illustrate the effect of the <code>traversal_filter</code> option. The resulting set of nodes includes samples and analyses. The analysis nodes are selected from that set using the <code>having</code> clause.</p>
<div class="cell" data-execution_count="6">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># Start with a as the target of a relation</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>q1 <span class="op">=</span> <span class="st">'target_s:a'</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co"># Traverse the graph starting from q1, limit relations being followed to sample-of and analysis-of</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>q2 <span class="op">=</span> <span class="st">'{!graph to=_nest_parent_ from=target_s traversal_filter="relation_type_s:[subsample-of OR analysis-of]"}'</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>ex1 <span class="op">=</span> <span class="st">'''search(</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="st">            reltest,</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="st">            q="{!graph </span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="st">                to=_nest_parent_ </span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="st">                from=target_s </span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="st">                traversal_filter='relation_type_s:[subsample-of OR analysis-of]'</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="st">            }target_s:a",</span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="st">            fl="*",</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="st">            rows=100</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="st">        )'''</span></span>
<span id="cb18-15"><a href="#cb18-15"></a><span class="co"># Fetch the records</span></span>
<span id="cb18-16"><a href="#cb18-16"></a>ex2 <span class="op">=</span> <span class="ss">f'''fetch(</span></span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="ss">        reltest,</span></span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="ss">        </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="ss">        fl="id,name_t,is_s,[child]",</span></span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="ss">        on="_nest_parent_=id"</span></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="ss">    )'''</span></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="co"># And include only records that are an analysis</span></span>
<span id="cb18-23"><a href="#cb18-23"></a>ex3 <span class="op">=</span> <span class="ss">f'''having(</span></span>
<span id="cb18-24"><a href="#cb18-24"></a><span class="ss">    </span><span class="sc">{</span>ex2<span class="sc">}</span><span class="ss">, </span></span>
<span id="cb18-25"><a href="#cb18-25"></a><span class="ss">    eq(is_s,"analysis")</span></span>
<span id="cb18-26"><a href="#cb18-26"></a><span class="ss">)'''</span></span>
<span id="cb18-27"><a href="#cb18-27"></a><span class="bu">print</span>(ex3)</span>
<span id="cb18-28"><a href="#cb18-28"></a>res <span class="op">=</span> solr.sendExpr(ex3)</span>
<span id="cb18-29"><a href="#cb18-29"></a>solr.render(example_graph.docs, res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>having(
    fetch(
        reltest,
        search(
            reltest,
            q="{!graph 
                to=_nest_parent_ 
                from=target_s 
                traversal_filter='relation_type_s:[subsample-of OR analysis-of]'
            }target_s:a",
            fl="*",
            rows=100
        ),
        fl="id,name_t,is_s,[child]",
        on="_nest_parent_=id"
    ), 
    eq(is_s,"analysis")
)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="graph_traversal01_files/figure-html/cell-7-output-2.svg" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="graph-math" class="level2">
<h2 class="anchored" data-anchor-id="graph-math">Graph Math</h2>
<section id="union-of-two-graphs" class="level3">
<h3 class="anchored" data-anchor-id="union-of-two-graphs">Union of two graphs</h3>
<p>In the simplest case, this is following ancestors or descendants from two or more root nodes. In the case where there are two graphs constructed differently and we need the set of all nodes included in both, then we can OR the two queries and if necessary apply a Unique stream decorator.</p>
</section>
<section id="difference-of-two-graphs" class="level3">
<h3 class="anchored" data-anchor-id="difference-of-two-graphs">Difference of two graphs</h3>
<p>Use the conjunction stream decorator.</p>
</section>
<section id="number-of-nodes-in-a-graph" class="level3">
<h3 class="anchored" data-anchor-id="number-of-nodes-in-a-graph">Number of nodes in a graph</h3>
<p>Can be achieved programmatically by counting the nodes or by applying an operation such as <a href="https://solr.apache.org/guide/solr/latest/query-guide/stream-decorator-reference.html#rollup"><code>rollup</code></a> using a <code>count(*)</code> metric.</p>
</section>
</section>
<section id="other-solr-graph-methods" class="level2">
<h2 class="anchored" data-anchor-id="other-solr-graph-methods">Other Solr graph methods</h2>
<section id="shortestpath" class="level3">
<h3 class="anchored" data-anchor-id="shortestpath"><code>shortestPath</code></h3>
<p>The <a href="https://solr.apache.org/guide/solr/latest/query-guide/stream-source-reference.html#shortestpath"><code>shortestPath</code></a> stream source computes the paths between two node, returned as a list of tuples. Each tuple contains the node IDs on a path between the starting nodes.</p>
<div class="cell" data-execution_count="7">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>expr <span class="op">=</span> <span class="st">'''shortestPath(</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">    reltest,</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="st">    from="ddd",</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">    to="a",</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="st">    edge="_nest_parent_=target_s",</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="st">    maxDepth=50</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="st">)'''</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="bu">print</span>(expr)</span>
<span id="cb20-9"><a href="#cb20-9"></a>res <span class="op">=</span> solr.sendExpr(expr)</span>
<span id="cb20-10"><a href="#cb20-10"></a>solr.render(example_graph.docs, res, show_docs<span class="op">=</span><span class="va">True</span>, show_graph<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>shortestPath(
    reltest,
    from="ddd",
    to="a",
    edge="_nest_parent_=target_s",
    maxDepth=50
)
{
  "result-set": {
    "docs": [
      {
        "path": [
          "ddd",
          "ccc",
          "aaa",
          "aa",
          "a"
        ]
      },
      {
        "path": [
          "ddd",
          "aaba",
          "aab",
          "ab",
          "a"
        ]
      },
      {
        "EOF": true,
        "RESPONSE_TIME": 16
      }
    ]
  }
}</code></pre>
</div>
</div>
</section>
<section id="nodes" class="level3">
<h3 class="anchored" data-anchor-id="nodes"><code>nodes</code></h3>
<p>The <a href="https://solr.apache.org/guide/solr/latest/query-guide/graph-traversal.html"><code>nodes</code></a> stream source does graph traversal, but does not iterate across all nodes of the graph. Instead the operation traverses one level at a time. <code>nodes</code> sources may be nested to reach deeper into a graph.</p>
<div class="cell" data-execution_count="8">
<details>
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>expr <span class="op">=</span> <span class="st">'''nodes(reltest,</span></span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="st">    nodes(</span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="st">        reltest,</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="st">        walk="ddd-&gt;_nest_parent_",</span></span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="st">        gather="target_s",</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="st">        scatter="branches, leaves"</span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="st">    ),</span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="st">    walk="node-&gt;_nest_parent_",</span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="st">    gather="target_s",</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="st">    scatter="branches, leaves"</span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="st">)'''</span></span>
<span id="cb22-12"><a href="#cb22-12"></a><span class="bu">print</span>(expr)</span>
<span id="cb22-13"><a href="#cb22-13"></a>res <span class="op">=</span> solr.sendExpr(expr)</span>
<span id="cb22-14"><a href="#cb22-14"></a>solr.render(example_graph.docs, res, show_docs<span class="op">=</span><span class="va">True</span>, show_graph<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>nodes(reltest,
    nodes(
        reltest,
        walk="ddd-&gt;_nest_parent_",
        gather="target_s",
        scatter="branches, leaves"
    ),
    walk="node-&gt;_nest_parent_",
    gather="target_s",
    scatter="branches, leaves"
)
{
  "result-set": {
    "docs": [
      {
        "node": "ddd",
        "collection": "reltest",
        "field": "node",
        "level": 0
      },
      {
        "node": "ccc",
        "collection": "reltest",
        "field": "target_s",
        "level": 1
      },
      {
        "node": "aaba",
        "collection": "reltest",
        "field": "target_s",
        "level": 1
      },
      {
        "node": "aaa",
        "collection": "reltest",
        "field": "target_s",
        "level": 2
      },
      {
        "node": "aab",
        "collection": "reltest",
        "field": "target_s",
        "level": 2
      },
      {
        "node": "baa",
        "collection": "reltest",
        "field": "target_s",
        "level": 2
      },
      {
        "EOF": true,
        "RESPONSE_TIME": 9
      }
    ]
  }
}</code></pre>
</div>
</div>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="an">title:</span><span class="co"> Graphing around with Solr</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="an">subtitle:</span><span class="co"> Traversing graphs</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="an">date:</span><span class="co"> 2022-08-30</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="an">format:</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co">  html:</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co">    toc: true</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co">    theme:</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="co">      - cosmo</span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="co">    css:</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">      - styles.css</span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co">    code-fold: true</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="co">    code-tools: true</span></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="co">    code-summary: "Show the code"</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co">    code-line-numbers: true</span></span>
<span id="cb24-17"><a href="#cb24-17"></a></span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="co">---</span></span>
<span id="cb24-19"><a href="#cb24-19"></a></span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="fu">## Ancestors</span></span>
<span id="cb24-21"><a href="#cb24-21"></a></span>
<span id="cb24-22"><a href="#cb24-22"></a>In the graph model used here the arrows are pointing from the descendant to the ancestor. It is done this way for practical purposes - it is easier to add edges to a derived record than to update an origin record each time a derivative is made. Hence, a <span class="in">`subsample-of`</span> relation here indicates that the record containing the relation is a subsample of the target of that relation, and the origin is an ancestor of the record. This basic pattern is shown in @fig-ancestry.</span>
<span id="cb24-23"><a href="#cb24-23"></a></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="in">```{dot}</span></span>
<span id="cb24-27"><a href="#cb24-27"></a>//| label: fig-ancestry</span>
<span id="cb24-28"><a href="#cb24-28"></a>//| fig<span class="ot">-c</span>ap: <span class="ot">"</span><span class="st">Ancestor2 is the original source record, Ancestor is a `sample-of` Ancestor2, and Descendant is a `sample-of` Ancestor.</span><span class="ot">"</span></span>
<span id="cb24-29"><a href="#cb24-29"></a>//| fig-height: <span class="fl">1.5</span></span>
<span id="cb24-30"><a href="#cb24-30"></a>digraph {</span>
<span id="cb24-31"><a href="#cb24-31"></a>    rankdir=<span class="ot">"</span><span class="st">RL</span><span class="ot">"</span></span>
<span id="cb24-32"><a href="#cb24-32"></a>    node1 [label=<span class="ot">"</span><span class="st">Decendant</span><span class="ch">\n</span><span class="st">A derived record</span><span class="ot">"</span>];</span>
<span id="cb24-33"><a href="#cb24-33"></a>    node2 [label=<span class="ot">"</span><span class="st">Ancestor</span><span class="ch">\n</span><span class="st">Intermediate record</span><span class="ot">"</span>];</span>
<span id="cb24-34"><a href="#cb24-34"></a>    node3 [label=<span class="ot">"</span><span class="st">Ancestor2</span><span class="ch">\n</span><span class="st">The source record</span><span class="ot">"</span>]</span>
<span id="cb24-35"><a href="#cb24-35"></a>    node1 -&gt; node2 [label=<span class="ot">"</span><span class="st">subsample-of</span><span class="ot">"</span>];</span>
<span id="cb24-36"><a href="#cb24-36"></a>    node2 -&gt; node3 [label=<span class="ot">"</span><span class="st">subsample-of</span><span class="ot">"</span>];</span>
<span id="cb24-37"><a href="#cb24-37"></a>}</span>
<span id="cb24-38"><a href="#cb24-38"></a><span class="in">```</span></span>
<span id="cb24-39"><a href="#cb24-39"></a>Expressed as JSON records:</span>
<span id="cb24-40"><a href="#cb24-40"></a><span class="in">```{.json}</span></span>
<span id="cb24-41"><a href="#cb24-41"></a>[</span>
<span id="cb24-42"><a href="#cb24-42"></a>    {</span>
<span id="cb24-43"><a href="#cb24-43"></a>        <span class="st">"id"</span><span class="op">:</span><span class="st">"Ancestor2"</span><span class="op">,</span></span>
<span id="cb24-44"><a href="#cb24-44"></a>        <span class="st">"name_t"</span><span class="op">:</span><span class="st">"The source record"</span><span class="op">,</span></span>
<span id="cb24-45"><a href="#cb24-45"></a>        <span class="st">"_root_"</span><span class="op">:</span><span class="st">"Ancestor"</span></span>
<span id="cb24-46"><a href="#cb24-46"></a>    }<span class="op">,</span></span>
<span id="cb24-47"><a href="#cb24-47"></a>    {</span>
<span id="cb24-48"><a href="#cb24-48"></a>        <span class="st">"id"</span><span class="op">:</span><span class="st">"Ancestor"</span><span class="op">,</span></span>
<span id="cb24-49"><a href="#cb24-49"></a>        <span class="st">"name_t"</span><span class="op">:</span><span class="st">"A derived record"</span><span class="op">,</span></span>
<span id="cb24-50"><a href="#cb24-50"></a>        <span class="st">"_root_"</span><span class="op">:</span><span class="st">"Ancestor"</span><span class="op">,</span></span>
<span id="cb24-51"><a href="#cb24-51"></a>        <span class="st">"edges"</span><span class="op">:</span>[</span>
<span id="cb24-52"><a href="#cb24-52"></a>            {</span>
<span id="cb24-53"><a href="#cb24-53"></a>                <span class="st">"id"</span><span class="op">:</span><span class="st">"relation_01"</span><span class="op">,</span></span>
<span id="cb24-54"><a href="#cb24-54"></a>                <span class="st">"relation_type_s"</span><span class="op">:</span><span class="st">"subsample-of"</span><span class="op">,</span></span>
<span id="cb24-55"><a href="#cb24-55"></a>                <span class="st">"target_s"</span><span class="op">:</span><span class="st">"Ancestor2"</span><span class="op">,</span></span>
<span id="cb24-56"><a href="#cb24-56"></a>                <span class="st">"_nest_parent_"</span><span class="op">:</span><span class="st">"Ancestor"</span><span class="op">,</span></span>
<span id="cb24-57"><a href="#cb24-57"></a>                <span class="st">"_root_"</span><span class="op">:</span><span class="st">"Ancestor"</span><span class="op">,</span></span>
<span id="cb24-58"><a href="#cb24-58"></a>                <span class="st">"_nest_path_"</span><span class="op">:</span><span class="st">"/edges#0"</span></span>
<span id="cb24-59"><a href="#cb24-59"></a>            }</span>
<span id="cb24-60"><a href="#cb24-60"></a>        ]</span>
<span id="cb24-61"><a href="#cb24-61"></a>    }<span class="op">,</span></span>
<span id="cb24-62"><a href="#cb24-62"></a>    {</span>
<span id="cb24-63"><a href="#cb24-63"></a>        <span class="st">"id"</span><span class="op">:</span><span class="st">"Descendant"</span><span class="op">,</span></span>
<span id="cb24-64"><a href="#cb24-64"></a>        <span class="st">"name_t"</span><span class="op">:</span><span class="st">"Another derived record"</span><span class="op">,</span></span>
<span id="cb24-65"><a href="#cb24-65"></a>        <span class="st">"_root_"</span><span class="op">:</span><span class="st">"Descendant"</span><span class="op">,</span></span>
<span id="cb24-66"><a href="#cb24-66"></a>        <span class="st">"edges"</span><span class="op">:</span>[</span>
<span id="cb24-67"><a href="#cb24-67"></a>            {</span>
<span id="cb24-68"><a href="#cb24-68"></a>                <span class="st">"id"</span><span class="op">:</span><span class="st">"relation_02"</span><span class="op">,</span></span>
<span id="cb24-69"><a href="#cb24-69"></a>                <span class="st">"relation_type_s"</span><span class="op">:</span><span class="st">"subsample-of"</span><span class="op">,</span></span>
<span id="cb24-70"><a href="#cb24-70"></a>                <span class="st">"target_s"</span><span class="op">:</span><span class="st">"Ancestor"</span><span class="op">,</span></span>
<span id="cb24-71"><a href="#cb24-71"></a>                <span class="st">"_nest_parent_"</span><span class="op">:</span><span class="st">"Descendant"</span><span class="op">,</span></span>
<span id="cb24-72"><a href="#cb24-72"></a>                <span class="st">"_root_"</span><span class="op">:</span><span class="st">"Descendant"</span><span class="op">,</span></span>
<span id="cb24-73"><a href="#cb24-73"></a>                <span class="st">"_nest_path_"</span><span class="op">:</span><span class="st">"/edges#0"</span></span>
<span id="cb24-74"><a href="#cb24-74"></a>            }</span>
<span id="cb24-75"><a href="#cb24-75"></a>        ]</span>
<span id="cb24-76"><a href="#cb24-76"></a>    }</span>
<span id="cb24-77"><a href="#cb24-77"></a>]</span>
<span id="cb24-78"><a href="#cb24-78"></a><span class="in">```</span></span>
<span id="cb24-79"><a href="#cb24-79"></a>::: {.column-margin .callout-note}</span>
<span id="cb24-80"><a href="#cb24-80"></a>The fields <span class="in">`_root_`</span>, <span class="in">`_nest_parent_`</span>, and <span class="in">`_nest_path_`</span> are computed by Solr, and should not be included in the documents when indexing. They are included here to indicate the values set by Solr.</span>
<span id="cb24-81"><a href="#cb24-81"></a>:::</span>
<span id="cb24-82"><a href="#cb24-82"></a></span>
<span id="cb24-83"><a href="#cb24-83"></a>The basic form of a solr query for this operation is a <span class="co">[</span><span class="ot">graph expression</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/other-parsers.html#graph-query-parser)</span> traversing from a descendant record to targets of the relations. </span>
<span id="cb24-84"><a href="#cb24-84"></a></span>
<span id="cb24-85"><a href="#cb24-85"></a>The graph query:</span>
<span id="cb24-86"><a href="#cb24-86"></a><span class="in">```</span></span>
<span id="cb24-87"><a href="#cb24-87"></a><span class="in">{!graph from=FROM_FIELD to=TO_FIELD}ROOT_DOCUMENTS</span></span>
<span id="cb24-88"><a href="#cb24-88"></a><span class="in">```</span></span>
<span id="cb24-89"><a href="#cb24-89"></a>roughly corresponds to the pseudo code:</span>
<span id="cb24-90"><a href="#cb24-90"></a></span>
<span id="cb24-91"><a href="#cb24-91"></a><span class="in">```</span></span>
<span id="cb24-92"><a href="#cb24-92"></a><span class="in">start_docs = ROOT_DOCUMENTS</span></span>
<span id="cb24-93"><a href="#cb24-93"></a><span class="in">while start_docs is not empty:</span></span>
<span id="cb24-94"><a href="#cb24-94"></a><span class="in">    for each document in start_docs:</span></span>
<span id="cb24-95"><a href="#cb24-95"></a><span class="in">        for each value of TO_FIELD:</span></span>
<span id="cb24-96"><a href="#cb24-96"></a><span class="in">            set start_docs to documents with FROM_FIELD matching value</span></span>
<span id="cb24-97"><a href="#cb24-97"></a><span class="in">```</span></span>
<span id="cb24-98"><a href="#cb24-98"></a></span>
<span id="cb24-99"><a href="#cb24-99"></a>Where:</span>
<span id="cb24-100"><a href="#cb24-100"></a></span>
<span id="cb24-101"><a href="#cb24-101"></a>FROM_FIELD</span>
<span id="cb24-102"><a href="#cb24-102"></a>:  Name of the field examined for incoming edges.</span>
<span id="cb24-103"><a href="#cb24-103"></a></span>
<span id="cb24-104"><a href="#cb24-104"></a>TO_FIELD</span>
<span id="cb24-105"><a href="#cb24-105"></a>:  Name of the field listing outgoing edges.</span>
<span id="cb24-106"><a href="#cb24-106"></a></span>
<span id="cb24-107"><a href="#cb24-107"></a>ROOT_DOCUMENTS</span>
<span id="cb24-108"><a href="#cb24-108"></a>:  The list of documents providing starting points for graph traversal.</span>
<span id="cb24-109"><a href="#cb24-109"></a></span>
<span id="cb24-110"><a href="#cb24-110"></a>In the two node example above, <span class="in">`FROM_FIELD`</span> corresponds to the parent of the <span class="in">`related`</span> edge documents and <span class="in">`TO_FIELD`</span> corresponds with the <span class="in">`target_s`</span> value of the edge document.</span>
<span id="cb24-111"><a href="#cb24-111"></a></span>
<span id="cb24-112"><a href="#cb24-112"></a>Since relations are held in the nested documents, it is necessary to seed the starting points of the graph traversal with the nested child relation documents, however we are typically quarying on properties of the parent of the nested child. Hence the root nodes for starting the traversal are found by selecting the child documents of parent documents that match some filter. This is done using the Solr <span class="co">[</span><span class="ot">`!child`</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/searching-nested-documents.html#child-query-parser)</span> query parser:</span>
<span id="cb24-113"><a href="#cb24-113"></a></span>
<span id="cb24-114"><a href="#cb24-114"></a><span class="in">```</span></span>
<span id="cb24-115"><a href="#cb24-115"></a><span class="in">{!child of=PARENT_MASK}SOME_PARENTS</span></span>
<span id="cb24-116"><a href="#cb24-116"></a><span class="in">```</span></span>
<span id="cb24-117"><a href="#cb24-117"></a>where:</span>
<span id="cb24-118"><a href="#cb24-118"></a></span>
<span id="cb24-119"><a href="#cb24-119"></a>SOME_PARENTS</span>
<span id="cb24-120"><a href="#cb24-120"></a>:  Query returing some parent documents, e.g. <span class="in">`*:*`</span> or <span class="in">`id:Descendant`</span>.</span>
<span id="cb24-121"><a href="#cb24-121"></a></span>
<span id="cb24-122"><a href="#cb24-122"></a>PARENT_MASK</span>
<span id="cb24-123"><a href="#cb24-123"></a>:  Filter applied to SOME_PARENTS. This will typically match all parent documents, e.g. <span class="in">`*:* -_nest_path_:*`</span> (all documents in SOME_PARENTS that don't have a <span class="in">`_nest_path_`</span> field).</span>
<span id="cb24-124"><a href="#cb24-124"></a></span>
<span id="cb24-125"><a href="#cb24-125"></a>Combining the <span class="in">`!graph`</span> and <span class="in">`!child`</span> query parsers provides a pattern facilitating traversal across ancestor documents. For example:</span>
<span id="cb24-126"><a href="#cb24-126"></a></span>
<span id="cb24-127"><a href="#cb24-127"></a><span class="in">```</span></span>
<span id="cb24-128"><a href="#cb24-128"></a><span class="in">{!graph </span></span>
<span id="cb24-129"><a href="#cb24-129"></a><span class="in">    from=_nest_parent_ </span></span>
<span id="cb24-130"><a href="#cb24-130"></a><span class="in">    to=target_s</span></span>
<span id="cb24-131"><a href="#cb24-131"></a><span class="in">}(  </span></span>
<span id="cb24-132"><a href="#cb24-132"></a><span class="in">    {!child</span></span>
<span id="cb24-133"><a href="#cb24-133"></a><span class="in">        of="*:* -_nest_path_:*"</span></span>
<span id="cb24-134"><a href="#cb24-134"></a><span class="in">    }id:Descendant</span></span>
<span id="cb24-135"><a href="#cb24-135"></a><span class="in">)</span></span>
<span id="cb24-136"><a href="#cb24-136"></a><span class="in">```</span></span>
<span id="cb24-137"><a href="#cb24-137"></a>Says given the child document of the document with <span class="in">`id`</span> of "<span class="in">`Descendant`</span>", get documents with <span class="in">`_nest_parent_`</span> matching the value of <span class="in">`_target_s`</span>.  At this point, we have all the <span class="in">`related`</span> nested documents that point to ancestors of "<span class="in">`Descendant`</span>", which in this case is simply the single document with identifier "<span class="in">`relation_01`</span>". </span>
<span id="cb24-138"><a href="#cb24-138"></a></span>
<span id="cb24-139"><a href="#cb24-139"></a>Note that the ancestors are actually the documents that are referenced from the value of the <span class="in">`target_s`</span> field. There are a couple options to retrieve those documents. One is the <span class="co">[</span><span class="ot">`!join`</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/join-query-parser.html)</span> query parser:</span>
<span id="cb24-140"><a href="#cb24-140"></a></span>
<span id="cb24-141"><a href="#cb24-141"></a><span class="in">```</span></span>
<span id="cb24-142"><a href="#cb24-142"></a><span class="in">{!join</span></span>
<span id="cb24-143"><a href="#cb24-143"></a><span class="in">    from=target_s</span></span>
<span id="cb24-144"><a href="#cb24-144"></a><span class="in">    to=id</span></span>
<span id="cb24-145"><a href="#cb24-145"></a><span class="in">}(</span></span>
<span id="cb24-146"><a href="#cb24-146"></a><span class="in">    {!graph </span></span>
<span id="cb24-147"><a href="#cb24-147"></a><span class="in">        from=_nest_parent_ </span></span>
<span id="cb24-148"><a href="#cb24-148"></a><span class="in">        to=target_s</span></span>
<span id="cb24-149"><a href="#cb24-149"></a><span class="in">    }(  </span></span>
<span id="cb24-150"><a href="#cb24-150"></a><span class="in">        {!child</span></span>
<span id="cb24-151"><a href="#cb24-151"></a><span class="in">            of="*:* -_nest_path_:*"</span></span>
<span id="cb24-152"><a href="#cb24-152"></a><span class="in">        }id:Descendant</span></span>
<span id="cb24-153"><a href="#cb24-153"></a><span class="in">    )</span></span>
<span id="cb24-154"><a href="#cb24-154"></a><span class="in">)</span></span>
<span id="cb24-155"><a href="#cb24-155"></a><span class="in">```</span></span>
<span id="cb24-156"><a href="#cb24-156"></a></span>
<span id="cb24-157"><a href="#cb24-157"></a>An alternative, when using streaming expressesions is to use the <span class="co">[</span><span class="ot">`fetch`</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/stream-decorator-reference.html#fetch)</span> stream decorator:</span>
<span id="cb24-158"><a href="#cb24-158"></a></span>
<span id="cb24-159"><a href="#cb24-159"></a><span class="in">```</span></span>
<span id="cb24-160"><a href="#cb24-160"></a><span class="in">fetch(COLLECTION,</span></span>
<span id="cb24-161"><a href="#cb24-161"></a><span class="in">    search(COLLECTION,</span></span>
<span id="cb24-162"><a href="#cb24-162"></a><span class="in">        q="{!graph </span></span>
<span id="cb24-163"><a href="#cb24-163"></a><span class="in">                from=_nest_parent_ </span></span>
<span id="cb24-164"><a href="#cb24-164"></a><span class="in">                to=target_s</span></span>
<span id="cb24-165"><a href="#cb24-165"></a><span class="in">            }(  </span></span>
<span id="cb24-166"><a href="#cb24-166"></a><span class="in">            {!child</span></span>
<span id="cb24-167"><a href="#cb24-167"></a><span class="in">                of='*:* -_nest_path_:*'</span></span>
<span id="cb24-168"><a href="#cb24-168"></a><span class="in">            }id:Descendant</span></span>
<span id="cb24-169"><a href="#cb24-169"></a><span class="in">        )",</span></span>
<span id="cb24-170"><a href="#cb24-170"></a><span class="in">    ),</span></span>
<span id="cb24-171"><a href="#cb24-171"></a><span class="in">    fl="id, name_t",</span></span>
<span id="cb24-172"><a href="#cb24-172"></a><span class="in">    on="target_s=id"</span></span>
<span id="cb24-173"><a href="#cb24-173"></a><span class="in">)</span></span>
<span id="cb24-174"><a href="#cb24-174"></a><span class="in">```</span></span>
<span id="cb24-175"><a href="#cb24-175"></a></span>
<span id="cb24-176"><a href="#cb24-176"></a><span class="fu">### Ancestors of a specific node</span></span>
<span id="cb24-177"><a href="#cb24-177"></a></span>
<span id="cb24-178"><a href="#cb24-178"></a>The two ancestor approaches are illustrated here using the <span class="in">`example_graph`</span>.</span>
<span id="cb24-179"><a href="#cb24-179"></a></span>
<span id="cb24-180"><a href="#cb24-180"></a>In both cases, we are looking for all records that are the ancestors of the node <span class="in">`id:ddd`</span>. This could easily be expanded to include many starting root nodes by adjusting the initial filter query to match multiple nodes..</span>
<span id="cb24-181"><a href="#cb24-181"></a></span>
<span id="cb24-182"><a href="#cb24-182"></a>The first uses the <span class="in">`!join`</span> query expression. See @fig-n1.</span>
<span id="cb24-183"><a href="#cb24-183"></a></span>
<span id="cb24-186"><a href="#cb24-186"></a><span class="in">```{python}</span></span>
<span id="cb24-187"><a href="#cb24-187"></a><span class="co">#| label: fig-n1</span></span>
<span id="cb24-188"><a href="#cb24-188"></a><span class="co">#| fig-cap: "A line plot on a polar axis"</span></span>
<span id="cb24-189"><a href="#cb24-189"></a></span>
<span id="cb24-190"><a href="#cb24-190"></a><span class="im">import</span> example_graph</span>
<span id="cb24-191"><a href="#cb24-191"></a><span class="im">import</span> graphutzing</span>
<span id="cb24-192"><a href="#cb24-192"></a></span>
<span id="cb24-193"><a href="#cb24-193"></a>solr <span class="op">=</span> graphutzing.SolrConnection()</span>
<span id="cb24-194"><a href="#cb24-194"></a></span>
<span id="cb24-195"><a href="#cb24-195"></a>ex0 <span class="op">=</span> <span class="st">'''search(reltest,</span></span>
<span id="cb24-196"><a href="#cb24-196"></a><span class="st">    q="{!join </span></span>
<span id="cb24-197"><a href="#cb24-197"></a><span class="st">            from=target_s </span></span>
<span id="cb24-198"><a href="#cb24-198"></a><span class="st">            to=id</span></span>
<span id="cb24-199"><a href="#cb24-199"></a><span class="st">        }{!graph </span></span>
<span id="cb24-200"><a href="#cb24-200"></a><span class="st">            from=_nest_parent_ </span></span>
<span id="cb24-201"><a href="#cb24-201"></a><span class="st">            to=target_s</span></span>
<span id="cb24-202"><a href="#cb24-202"></a><span class="st">        }({!child </span></span>
<span id="cb24-203"><a href="#cb24-203"></a><span class="st">            of='*:* -_nest_path_:*'</span></span>
<span id="cb24-204"><a href="#cb24-204"></a><span class="st">        }id:ddd)",</span></span>
<span id="cb24-205"><a href="#cb24-205"></a><span class="st">    fl="*",</span></span>
<span id="cb24-206"><a href="#cb24-206"></a><span class="st">    rows=100</span></span>
<span id="cb24-207"><a href="#cb24-207"></a><span class="st">)'''</span></span>
<span id="cb24-208"><a href="#cb24-208"></a><span class="bu">print</span>(ex0)</span>
<span id="cb24-209"><a href="#cb24-209"></a>res <span class="op">=</span> solr.sendExpr(ex0)</span>
<span id="cb24-210"><a href="#cb24-210"></a>solr.render(example_graph.docs, res)</span>
<span id="cb24-211"><a href="#cb24-211"></a><span class="in">```</span></span>
<span id="cb24-212"><a href="#cb24-212"></a></span>
<span id="cb24-213"><a href="#cb24-213"></a>The second uses the <span class="in">`fetch`</span> stream decorator, see @fig-n2:</span>
<span id="cb24-216"><a href="#cb24-216"></a><span class="in">```{python}</span></span>
<span id="cb24-217"><a href="#cb24-217"></a><span class="co">#| label: fig-n2</span></span>
<span id="cb24-218"><a href="#cb24-218"></a><span class="co">#| fig-cap: "A line plot on a polar axis"</span></span>
<span id="cb24-219"><a href="#cb24-219"></a></span>
<span id="cb24-220"><a href="#cb24-220"></a>ex1 <span class="op">=</span> <span class="st">'''search(reltest,</span></span>
<span id="cb24-221"><a href="#cb24-221"></a><span class="st">        q="{!graph </span></span>
<span id="cb24-222"><a href="#cb24-222"></a><span class="st">            to=target_s </span></span>
<span id="cb24-223"><a href="#cb24-223"></a><span class="st">            from=_nest_parent_</span></span>
<span id="cb24-224"><a href="#cb24-224"></a><span class="st">        }({!child </span></span>
<span id="cb24-225"><a href="#cb24-225"></a><span class="st">            of='*:* -_nest_path_:*'</span></span>
<span id="cb24-226"><a href="#cb24-226"></a><span class="st">        }id:ddd)",</span></span>
<span id="cb24-227"><a href="#cb24-227"></a><span class="st">        fl="*",</span></span>
<span id="cb24-228"><a href="#cb24-228"></a><span class="st">        rows=100</span></span>
<span id="cb24-229"><a href="#cb24-229"></a><span class="st">    )'''</span></span>
<span id="cb24-230"><a href="#cb24-230"></a>ex2 <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb24-231"><a href="#cb24-231"></a><span class="ss">fetch(reltest,</span></span>
<span id="cb24-232"><a href="#cb24-232"></a><span class="ss">    </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb24-233"><a href="#cb24-233"></a><span class="ss">    fl="id,name_t",</span></span>
<span id="cb24-234"><a href="#cb24-234"></a><span class="ss">    on="target_s=id"</span></span>
<span id="cb24-235"><a href="#cb24-235"></a><span class="ss">)'''</span></span>
<span id="cb24-236"><a href="#cb24-236"></a><span class="bu">print</span>(ex2)</span>
<span id="cb24-237"><a href="#cb24-237"></a>res <span class="op">=</span> solr.sendExpr(ex2)</span>
<span id="cb24-238"><a href="#cb24-238"></a>solr.render(example_graph.docs, res)</span>
<span id="cb24-239"><a href="#cb24-239"></a><span class="in">```</span></span>
<span id="cb24-240"><a href="#cb24-240"></a></span>
<span id="cb24-241"><a href="#cb24-241"></a><span class="fu">### Ancestors matching some property</span></span>
<span id="cb24-242"><a href="#cb24-242"></a></span>
<span id="cb24-243"><a href="#cb24-243"></a>This pattern can be used to find ancestors that match a filter. </span>
<span id="cb24-244"><a href="#cb24-244"></a></span>
<span id="cb24-245"><a href="#cb24-245"></a>In this case, documents that are the ancestor of <span class="in">`ccc`</span> are found by an ancestor graph traversal, then only the documents from that set that are samples (<span class="in">`is_s:sample`</span>) are returned.</span>
<span id="cb24-246"><a href="#cb24-246"></a></span>
<span id="cb24-249"><a href="#cb24-249"></a><span class="in">```{python}</span></span>
<span id="cb24-250"><a href="#cb24-250"></a>ex1 <span class="op">=</span> <span class="st">'''    search(reltest, </span></span>
<span id="cb24-251"><a href="#cb24-251"></a><span class="st">            q="{!graph </span></span>
<span id="cb24-252"><a href="#cb24-252"></a><span class="st">                to=target_s </span></span>
<span id="cb24-253"><a href="#cb24-253"></a><span class="st">                from=_nest_parent_</span></span>
<span id="cb24-254"><a href="#cb24-254"></a><span class="st">            }(_nest_parent_:ccc)",</span></span>
<span id="cb24-255"><a href="#cb24-255"></a><span class="st">            fl="*,target_s,_nest_parent_,[child]",</span></span>
<span id="cb24-256"><a href="#cb24-256"></a><span class="st">            rows=100</span></span>
<span id="cb24-257"><a href="#cb24-257"></a><span class="st">        )'''</span></span>
<span id="cb24-258"><a href="#cb24-258"></a><span class="co"># Using the fetch operation to retrieve fields from documents found in the graph walk</span></span>
<span id="cb24-259"><a href="#cb24-259"></a>ex2 <span class="op">=</span> <span class="ss">f'''fetch(reltest,</span></span>
<span id="cb24-260"><a href="#cb24-260"></a><span class="ss">    </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb24-261"><a href="#cb24-261"></a><span class="ss">        fl="id,name_t,is_s,[child]",</span></span>
<span id="cb24-262"><a href="#cb24-262"></a><span class="ss">        on="target_s=id"</span></span>
<span id="cb24-263"><a href="#cb24-263"></a><span class="ss">    )'''</span></span>
<span id="cb24-264"><a href="#cb24-264"></a>ex3 <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb24-265"><a href="#cb24-265"></a><span class="ss">having(</span></span>
<span id="cb24-266"><a href="#cb24-266"></a><span class="ss">    </span><span class="sc">{</span>ex2<span class="sc">}</span><span class="ss">, </span></span>
<span id="cb24-267"><a href="#cb24-267"></a><span class="ss">    eq(is_s,"sample")</span></span>
<span id="cb24-268"><a href="#cb24-268"></a><span class="ss">)'''</span></span>
<span id="cb24-269"><a href="#cb24-269"></a><span class="bu">print</span>(ex3)</span>
<span id="cb24-270"><a href="#cb24-270"></a>res <span class="op">=</span> solr.sendExpr(ex3)</span>
<span id="cb24-271"><a href="#cb24-271"></a>solr.render(example_graph.docs, res)</span>
<span id="cb24-272"><a href="#cb24-272"></a><span class="in">```</span></span>
<span id="cb24-273"><a href="#cb24-273"></a></span>
<span id="cb24-274"><a href="#cb24-274"></a><span class="fu">## Descendants</span></span>
<span id="cb24-275"><a href="#cb24-275"></a></span>
<span id="cb24-276"><a href="#cb24-276"></a>Finding Descendants is similar to finding ancestors, except we are walking the graph in the opposite direction, so the <span class="in">`to`</span> and <span class="in">`from`</span> properties of the <span class="in">`!graph`</span> expression are reversed. Since the Descendants contain the nested relations, retrieving the parent document is a bit simpler since it is just the documents with <span class="in">`id`</span> matching <span class="in">`_nest_parent_`</span>.</span>
<span id="cb24-277"><a href="#cb24-277"></a></span>
<span id="cb24-278"><a href="#cb24-278"></a><span class="fu">### Descendants of a node</span></span>
<span id="cb24-279"><a href="#cb24-279"></a></span>
<span id="cb24-280"><a href="#cb24-280"></a>In this example derivatives (i.e. Descendants) of <span class="in">`id:b`</span> are found.</span>
<span id="cb24-281"><a href="#cb24-281"></a></span>
<span id="cb24-284"><a href="#cb24-284"></a><span class="in">```{python}</span></span>
<span id="cb24-285"><a href="#cb24-285"></a>ex1 <span class="op">=</span> <span class="st">'''    search(</span></span>
<span id="cb24-286"><a href="#cb24-286"></a><span class="st">        reltest,</span></span>
<span id="cb24-287"><a href="#cb24-287"></a><span class="st">        q="{!graph </span></span>
<span id="cb24-288"><a href="#cb24-288"></a><span class="st">            to=_nest_parent_ </span></span>
<span id="cb24-289"><a href="#cb24-289"></a><span class="st">            from=target_s</span></span>
<span id="cb24-290"><a href="#cb24-290"></a><span class="st">        }target_s:b",</span></span>
<span id="cb24-291"><a href="#cb24-291"></a><span class="st">        fl="*",</span></span>
<span id="cb24-292"><a href="#cb24-292"></a><span class="st">        rows=100</span></span>
<span id="cb24-293"><a href="#cb24-293"></a><span class="st">    )'''</span></span>
<span id="cb24-294"><a href="#cb24-294"></a>ex2 <span class="op">=</span> <span class="ss">f'''fetch(</span></span>
<span id="cb24-295"><a href="#cb24-295"></a><span class="ss">    reltest,</span></span>
<span id="cb24-296"><a href="#cb24-296"></a><span class="ss">    </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb24-297"><a href="#cb24-297"></a><span class="ss">    fl="id,name_t,[child]",</span></span>
<span id="cb24-298"><a href="#cb24-298"></a><span class="ss">    on="_nest_parent_=id"</span></span>
<span id="cb24-299"><a href="#cb24-299"></a><span class="ss">)</span></span>
<span id="cb24-300"><a href="#cb24-300"></a><span class="ss">'''</span></span>
<span id="cb24-301"><a href="#cb24-301"></a><span class="bu">print</span>(ex2)</span>
<span id="cb24-302"><a href="#cb24-302"></a>res <span class="op">=</span> solr.sendExpr(ex2)</span>
<span id="cb24-303"><a href="#cb24-303"></a>solr.render(example_graph.docs, res)</span>
<span id="cb24-304"><a href="#cb24-304"></a><span class="in">```</span></span>
<span id="cb24-305"><a href="#cb24-305"></a></span>
<span id="cb24-306"><a href="#cb24-306"></a>Alternatively, we can use the <span class="in">`!parent`</span> query parser to similar effect:</span>
<span id="cb24-307"><a href="#cb24-307"></a></span>
<span id="cb24-310"><a href="#cb24-310"></a><span class="in">```{python}</span></span>
<span id="cb24-311"><a href="#cb24-311"></a>ex1 <span class="op">=</span> <span class="st">'''search(reltest,</span></span>
<span id="cb24-312"><a href="#cb24-312"></a><span class="st">    q="{!parent which='*:* -_nest_path_:*'}({!graph </span></span>
<span id="cb24-313"><a href="#cb24-313"></a><span class="st">        to=_nest_parent_ </span></span>
<span id="cb24-314"><a href="#cb24-314"></a><span class="st">        from=target_s</span></span>
<span id="cb24-315"><a href="#cb24-315"></a><span class="st">    }target_s:b)",</span></span>
<span id="cb24-316"><a href="#cb24-316"></a><span class="st">    fl="*",</span></span>
<span id="cb24-317"><a href="#cb24-317"></a><span class="st">    rows=100</span></span>
<span id="cb24-318"><a href="#cb24-318"></a><span class="st">)'''</span></span>
<span id="cb24-319"><a href="#cb24-319"></a><span class="bu">print</span>(ex1)</span>
<span id="cb24-320"><a href="#cb24-320"></a>res <span class="op">=</span> solr.sendExpr(ex1)</span>
<span id="cb24-321"><a href="#cb24-321"></a>solr.render(example_graph.docs, res)</span>
<span id="cb24-322"><a href="#cb24-322"></a><span class="in">```</span></span>
<span id="cb24-323"><a href="#cb24-323"></a></span>
<span id="cb24-324"><a href="#cb24-324"></a></span>
<span id="cb24-325"><a href="#cb24-325"></a><span class="fu">### Descendants matching a particular type</span></span>
<span id="cb24-326"><a href="#cb24-326"></a></span>
<span id="cb24-327"><a href="#cb24-327"></a>In this case we are looking for analyses that were performed on material derived from sample <span class="in">`a`</span>. </span>
<span id="cb24-328"><a href="#cb24-328"></a></span>
<span id="cb24-329"><a href="#cb24-329"></a>We follow the Descendants graph, but limit the traversal to only include <span class="in">`sample-of`</span> or <span class="in">`analysis-of`</span> relations to limit the reduce the scope of traversal. This exclusion is optional, but included here to illustrate the effect of the <span class="in">`traversal_filter`</span> option. The resulting set of nodes includes samples and analyses. The analysis nodes are selected from that set using the <span class="in">`having`</span> clause.</span>
<span id="cb24-330"><a href="#cb24-330"></a></span>
<span id="cb24-333"><a href="#cb24-333"></a><span class="in">```{python}</span></span>
<span id="cb24-334"><a href="#cb24-334"></a><span class="co"># Start with a as the target of a relation</span></span>
<span id="cb24-335"><a href="#cb24-335"></a>q1 <span class="op">=</span> <span class="st">'target_s:a'</span></span>
<span id="cb24-336"><a href="#cb24-336"></a><span class="co"># Traverse the graph starting from q1, limit relations being followed to sample-of and analysis-of</span></span>
<span id="cb24-337"><a href="#cb24-337"></a>q2 <span class="op">=</span> <span class="st">'{!graph to=_nest_parent_ from=target_s traversal_filter="relation_type_s:[subsample-of OR analysis-of]"}'</span></span>
<span id="cb24-338"><a href="#cb24-338"></a>ex1 <span class="op">=</span> <span class="st">'''search(</span></span>
<span id="cb24-339"><a href="#cb24-339"></a><span class="st">            reltest,</span></span>
<span id="cb24-340"><a href="#cb24-340"></a><span class="st">            q="{!graph </span></span>
<span id="cb24-341"><a href="#cb24-341"></a><span class="st">                to=_nest_parent_ </span></span>
<span id="cb24-342"><a href="#cb24-342"></a><span class="st">                from=target_s </span></span>
<span id="cb24-343"><a href="#cb24-343"></a><span class="st">                traversal_filter='relation_type_s:[subsample-of OR analysis-of]'</span></span>
<span id="cb24-344"><a href="#cb24-344"></a><span class="st">            }target_s:a",</span></span>
<span id="cb24-345"><a href="#cb24-345"></a><span class="st">            fl="*",</span></span>
<span id="cb24-346"><a href="#cb24-346"></a><span class="st">            rows=100</span></span>
<span id="cb24-347"><a href="#cb24-347"></a><span class="st">        )'''</span></span>
<span id="cb24-348"><a href="#cb24-348"></a><span class="co"># Fetch the records</span></span>
<span id="cb24-349"><a href="#cb24-349"></a>ex2 <span class="op">=</span> <span class="ss">f'''fetch(</span></span>
<span id="cb24-350"><a href="#cb24-350"></a><span class="ss">        reltest,</span></span>
<span id="cb24-351"><a href="#cb24-351"></a><span class="ss">        </span><span class="sc">{</span>ex1<span class="sc">}</span><span class="ss">,</span></span>
<span id="cb24-352"><a href="#cb24-352"></a><span class="ss">        fl="id,name_t,is_s,[child]",</span></span>
<span id="cb24-353"><a href="#cb24-353"></a><span class="ss">        on="_nest_parent_=id"</span></span>
<span id="cb24-354"><a href="#cb24-354"></a><span class="ss">    )'''</span></span>
<span id="cb24-355"><a href="#cb24-355"></a><span class="co"># And include only records that are an analysis</span></span>
<span id="cb24-356"><a href="#cb24-356"></a>ex3 <span class="op">=</span> <span class="ss">f'''having(</span></span>
<span id="cb24-357"><a href="#cb24-357"></a><span class="ss">    </span><span class="sc">{</span>ex2<span class="sc">}</span><span class="ss">, </span></span>
<span id="cb24-358"><a href="#cb24-358"></a><span class="ss">    eq(is_s,"analysis")</span></span>
<span id="cb24-359"><a href="#cb24-359"></a><span class="ss">)'''</span></span>
<span id="cb24-360"><a href="#cb24-360"></a><span class="bu">print</span>(ex3)</span>
<span id="cb24-361"><a href="#cb24-361"></a>res <span class="op">=</span> solr.sendExpr(ex3)</span>
<span id="cb24-362"><a href="#cb24-362"></a>solr.render(example_graph.docs, res)</span>
<span id="cb24-363"><a href="#cb24-363"></a><span class="in">```</span></span>
<span id="cb24-364"><a href="#cb24-364"></a></span>
<span id="cb24-365"><a href="#cb24-365"></a><span class="fu">## Graph Math</span></span>
<span id="cb24-366"><a href="#cb24-366"></a></span>
<span id="cb24-367"><a href="#cb24-367"></a><span class="fu">### Union of two graphs</span></span>
<span id="cb24-368"><a href="#cb24-368"></a></span>
<span id="cb24-369"><a href="#cb24-369"></a>In the simplest case, this is following ancestors or descendants from two or more root nodes. In the case where there are two graphs constructed differently and we need the set of all nodes included in both, then we can OR the two queries and if necessary apply a Unique stream decorator.</span>
<span id="cb24-370"><a href="#cb24-370"></a></span>
<span id="cb24-371"><a href="#cb24-371"></a><span class="fu">### Difference of two graphs</span></span>
<span id="cb24-372"><a href="#cb24-372"></a></span>
<span id="cb24-373"><a href="#cb24-373"></a>Use the conjunction stream decorator.</span>
<span id="cb24-374"><a href="#cb24-374"></a></span>
<span id="cb24-375"><a href="#cb24-375"></a><span class="fu">### Number of nodes in a graph</span></span>
<span id="cb24-376"><a href="#cb24-376"></a></span>
<span id="cb24-377"><a href="#cb24-377"></a>Can be achieved programmatically by counting the nodes or by applying an operation such as <span class="co">[</span><span class="ot">`rollup`</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/stream-decorator-reference.html#rollup)</span> using a <span class="in">`count(*)`</span> metric.</span>
<span id="cb24-378"><a href="#cb24-378"></a></span>
<span id="cb24-379"><a href="#cb24-379"></a><span class="fu">## Other Solr graph methods</span></span>
<span id="cb24-380"><a href="#cb24-380"></a></span>
<span id="cb24-381"><a href="#cb24-381"></a><span class="fu">### `shortestPath`</span></span>
<span id="cb24-382"><a href="#cb24-382"></a></span>
<span id="cb24-383"><a href="#cb24-383"></a>The <span class="co">[</span><span class="ot">`shortestPath`</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/stream-source-reference.html#shortestpath)</span> stream source computes the paths between two node, returned as a list of tuples. Each tuple contains the node IDs on a path between the starting nodes.</span>
<span id="cb24-384"><a href="#cb24-384"></a></span>
<span id="cb24-387"><a href="#cb24-387"></a><span class="in">```{python}</span></span>
<span id="cb24-388"><a href="#cb24-388"></a>expr <span class="op">=</span> <span class="st">'''shortestPath(</span></span>
<span id="cb24-389"><a href="#cb24-389"></a><span class="st">    reltest,</span></span>
<span id="cb24-390"><a href="#cb24-390"></a><span class="st">    from="ddd",</span></span>
<span id="cb24-391"><a href="#cb24-391"></a><span class="st">    to="a",</span></span>
<span id="cb24-392"><a href="#cb24-392"></a><span class="st">    edge="_nest_parent_=target_s",</span></span>
<span id="cb24-393"><a href="#cb24-393"></a><span class="st">    maxDepth=50</span></span>
<span id="cb24-394"><a href="#cb24-394"></a><span class="st">)'''</span></span>
<span id="cb24-395"><a href="#cb24-395"></a><span class="bu">print</span>(expr)</span>
<span id="cb24-396"><a href="#cb24-396"></a>res <span class="op">=</span> solr.sendExpr(expr)</span>
<span id="cb24-397"><a href="#cb24-397"></a>solr.render(example_graph.docs, res, show_docs<span class="op">=</span><span class="va">True</span>, show_graph<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-398"><a href="#cb24-398"></a><span class="in">```</span></span>
<span id="cb24-399"><a href="#cb24-399"></a></span>
<span id="cb24-400"><a href="#cb24-400"></a><span class="fu">### `nodes`</span></span>
<span id="cb24-401"><a href="#cb24-401"></a></span>
<span id="cb24-402"><a href="#cb24-402"></a>The <span class="co">[</span><span class="ot">`nodes`</span><span class="co">](https://solr.apache.org/guide/solr/latest/query-guide/graph-traversal.html)</span> stream source does graph traversal, but does not iterate across all nodes of the graph. Instead the operation traverses one level at a time. <span class="in">`nodes`</span> sources may be nested to reach deeper into a graph.</span>
<span id="cb24-405"><a href="#cb24-405"></a><span class="in">```{python}</span></span>
<span id="cb24-406"><a href="#cb24-406"></a>expr <span class="op">=</span> <span class="st">'''nodes(reltest,</span></span>
<span id="cb24-407"><a href="#cb24-407"></a><span class="st">    nodes(</span></span>
<span id="cb24-408"><a href="#cb24-408"></a><span class="st">        reltest,</span></span>
<span id="cb24-409"><a href="#cb24-409"></a><span class="st">        walk="ddd-&gt;_nest_parent_",</span></span>
<span id="cb24-410"><a href="#cb24-410"></a><span class="st">        gather="target_s",</span></span>
<span id="cb24-411"><a href="#cb24-411"></a><span class="st">        scatter="branches, leaves"</span></span>
<span id="cb24-412"><a href="#cb24-412"></a><span class="st">    ),</span></span>
<span id="cb24-413"><a href="#cb24-413"></a><span class="st">    walk="node-&gt;_nest_parent_",</span></span>
<span id="cb24-414"><a href="#cb24-414"></a><span class="st">    gather="target_s",</span></span>
<span id="cb24-415"><a href="#cb24-415"></a><span class="st">    scatter="branches, leaves"</span></span>
<span id="cb24-416"><a href="#cb24-416"></a><span class="st">)'''</span></span>
<span id="cb24-417"><a href="#cb24-417"></a><span class="bu">print</span>(expr)</span>
<span id="cb24-418"><a href="#cb24-418"></a>res <span class="op">=</span> solr.sendExpr(expr)</span>
<span id="cb24-419"><a href="#cb24-419"></a>solr.render(example_graph.docs, res, show_docs<span class="op">=</span><span class="va">True</span>, show_graph<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-420"><a href="#cb24-420"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>